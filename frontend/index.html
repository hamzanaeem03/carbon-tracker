<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carbon Footprint Tracker - Dev</title>

  <!-- Tailwind CDN for dev -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Carbon Footprint Tracker (Dev)</h1>
      <p class="text-slate-600">Add activities and see simple stats. Backend: <code>/api</code></p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Add Activity</h2>
        <form id="activityForm" class="space-y-3">
          <input id="userId" class="w-full p-2 border rounded" placeholder="User ID (eg. user1)" required />
          <select id="type" class="w-full p-2 border rounded">
            <option value="transport">Transport</option>
            <option value="electricity">Electricity</option>
            <option value="diet">Diet</option>
            <option value="waste">Waste</option>
          </select>

          <input id="subtype" class="w-full p-2 border rounded" placeholder="Subtype (e.g. car, beef)" />
          <input id="value" type="number" step="any" class="w-full p-2 border rounded" placeholder="Value (km / kWh / meals / kg)" />
          <button class="w-full bg-green-600 text-white py-2 rounded" type="submit">Add Activity</button>
        </form>
      </div>

      <div class="bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Stats</h2>
        <div id="globalStats" class="text-sm text-slate-700">Loading...</div>
      </div>

      <div class="col-span-1 md:col-span-2 bg-white p-4 rounded shadow">
        <h2 class="font-semibold mb-3">Recent Activities</h2>
        <div id="activitiesList" class="space-y-2">Loading...</div>
      </div>
    </section>
  </div>

<script>
const API_BASE = (location.hostname === 'localhost' ? 'http://localhost:4000' : `${location.protocol}//${location.hostname}:4000`);

async function loadGlobal() {
  try {
    const res = await fetch(API_BASE + '/api/global-stats');
    const data = await res.json();
    document.getElementById('globalStats').innerHTML = `
      <div>Total users: <strong>${data.totalUsers}</strong></div>
      <div>Total activities: <strong>${data.activitiesCount}</strong></div>
      <div>Total CO₂: <strong>${(data.totalCO2Kg || 0).toFixed(2)} kg</strong></div>
    `;
  } catch (e) {
    document.getElementById('globalStats').innerText = 'Could not load global stats';
  }
}

async function loadActivities(userId='user1') {
  try {
    const res = await fetch(API_BASE + '/api/activities/' + encodeURIComponent(userId));
    const arr = await res.json();
    const container = document.getElementById('activitiesList');
    if (!arr.length) container.innerHTML = '<div class="text-slate-500">No activities yet for ' + userId + '</div>';
    else container.innerHTML = arr.map(a => `
      <div class="p-2 border rounded flex justify-between items-center">
        <div>
          <div class="text-sm"><strong>${a.type}</strong> — ${a.subtype || '-'} (${a.value})</div>
          <div class="text-xs text-slate-500">CO₂: ${Number(a.co2Kg||0).toFixed(3)} kg — ${new Date(a.timestamp).toLocaleString()}</div>
        </div>
        <button data-id="${a._id}" class="deleteBtn text-red-600">Delete</button>
      </div>
    `).join('');
    document.querySelectorAll('.deleteBtn').forEach(b => b.addEventListener('click', async (ev) => {
      const id = ev.target.dataset.id;
      await fetch(API_BASE + '/api/activities/' + id, { method: 'DELETE' });
      loadGlobal(); loadActivities(document.getElementById('userId').value || 'user1');
    }));
  } catch (e) {
    document.getElementById('activitiesList').innerText = 'Could not load activities';
  }
}

document.getElementById('activityForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const userId = document.getElementById('userId').value || 'user1';
  const type = document.getElementById('type').value;
  const subtype = document.getElementById('subtype').value;
  const value = Number(document.getElementById('value').value || 0);
  await fetch(API_BASE + '/api/activities', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ userId, type, subtype, value })
  });
  document.getElementById('subtype').value = '';
  document.getElementById('value').value = '';
  loadGlobal(); loadActivities(userId);
});

window.addEventListener('load', () => {
  // default userId to quick dev
  const uid = 'user1';
  document.getElementById('userId').value = uid;
  loadGlobal();
  loadActivities(uid);
});
</script>
</body>
</html>
